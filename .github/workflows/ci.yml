name: Continuous Integration

on:
  pull_request:
    branches:
      - master
      - develop
  push:
    branches:
      - develop
      - feature/**
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

env:
  NODE_VERSION: "20.x"

jobs:
  # Detect which services have changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.changes.outputs.user-service }}
      question-service: ${{ steps.changes.outputs.question-service }}
      collaboration-service: ${{ steps.changes.outputs.collaboration-service }}
      matching-service: ${{ steps.changes.outputs.matching-service }}
      web-server: ${{ steps.changes.outputs.web-server }}
      github-actions: ${{ steps.changes.outputs.github-actions }}
      any-backend: ${{ steps.changes.outputs.any-backend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            user-service:
              - 'user-service/**'
            question-service:
              - 'question-service/**'
            collaboration-service:
              - 'collaboration-service/**'
            matching-service:
              - 'matching-service/**'
            web-server:
              - 'web-server/**'
            github-actions:
              - '.github/workflows/**'
            any-backend:
              - 'user-service/**'
              - 'question-service/**'
              - 'collaboration-service/**'
              - 'matching-service/**'
              - '.aws/**'
              - 'docker-compose.yml'
              - 'deploy-all-services.sh'

  # Stage 1: Code Quality & Security Scan
  code-quality:
    name: Code Quality & Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.any-backend == 'true' ||
      needs.detect-changes.outputs.web-server == 'true' ||
      needs.detect-changes.outputs.github-actions == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security audit
        run: |
          echo "ğŸ”’ Running security audit on changed services..."

          services=()
          if [ "${{ needs.detect-changes.outputs.user-service }}" == "true" ]; then
            services+=("user-service")
          fi
          if [ "${{ needs.detect-changes.outputs.question-service }}" == "true" ]; then
            services+=("question-service")
          fi
          if [ "${{ needs.detect-changes.outputs.collaboration-service }}" == "true" ]; then
            services+=("collaboration-service")
          fi
          if [ "${{ needs.detect-changes.outputs.matching-service }}" == "true" ]; then
            services+=("matching-service")
          fi
          if [ "${{ needs.detect-changes.outputs.web-server }}" == "true" ]; then
            services+=("web-server")
          fi

          if [ ${#services[@]} -eq 0 ]; then
            echo "âš ï¸ No services changed - skipping audit"
            exit 0
          fi

          for service in "${services[@]}"; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Auditing: $service"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -f "$service/package.json" ]; then
              cd $service
              npm audit --audit-level=high || true
              cd ..
            fi
          done

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --debug --only-verified

  # Stage 2: Build & Test Backend Services
  build-and-test-backend:
    name: Build & Test - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, code-quality]
    if: |
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.question-service == 'true' ||
      needs.detect-changes.outputs.collaboration-service == 'true' ||
      needs.detect-changes.outputs.matching-service == 'true'

    strategy:
      matrix:
        include:
          - service: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
          - service: question-service
            changed: ${{ needs.detect-changes.outputs.question-service }}
          - service: collaboration-service
            changed: ${{ needs.detect-changes.outputs.collaboration-service }}
          - service: matching-service
            changed: ${{ needs.detect-changes.outputs.matching-service }}
      fail-fast: false

    steps:
      - name: Check if service changed
        id: should-run
        run: |
          if [ "${{ matrix.changed }}" != "true" ]; then
            echo "â­ï¸ Skipping ${{ matrix.service }} - no changes detected"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Running checks for ${{ matrix.service }}"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.should-run.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.should-run.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        if: steps.should-run.outputs.skip != 'true'
        working-directory: ./${{ matrix.service }}
        run: |
          echo "ğŸ“¦ Installing dependencies for ${{ matrix.service }}..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        if: steps.should-run.outputs.skip != 'true'
        working-directory: ./${{ matrix.service }}
        run: |
          echo "ğŸ”¨ Building ${{ matrix.service }}..."
          if grep -q '"build":' package.json; then
            npm run build
          else
            echo "âš ï¸ No build script found - skipping build (JavaScript service)"
          fi

      - name: Run tests
        if: steps.should-run.outputs.skip != 'true'
        working-directory: ./${{ matrix.service }}
        run: |
          echo "ğŸ§ª Running tests for ${{ matrix.service }}..."
          if grep -q '"test":' package.json; then
            npm test || echo "âš ï¸ Tests failed or not configured"
          else
            echo "âš ï¸ No test script found in package.json"
          fi
        continue-on-error: true

      - name: Upload build artifacts
        if: steps.should-run.outputs.skip != 'true' && hashFiles(format('./{0}/dist', matrix.service)) != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: ./${{ matrix.service }}/dist
          retention-days: 1

  # Stage 3: Build & Test Frontend
  build-and-test-frontend:
    name: Build & Test - Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, code-quality]
    if: needs.detect-changes.outputs.web-server == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./web-server
        run: |
          echo "ğŸ“¦ Installing dependencies for web-server..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Build frontend
        working-directory: ./web-server
        run: |
          echo "ğŸ”¨ Building web-server..."
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-server-build
          path: ./web-server/dist
          retention-days: 1

  # Deploy Frontend to S3 + CloudFront (master branch only)
  deploy-frontend:
    name: Deploy Frontend to S3 + CloudFront
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test-frontend]
    if: |
      github.ref == 'refs/heads/master' &&
      needs.detect-changes.outputs.web-server == 'true'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-server-build
          path: ./dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Sync to S3
        run: |
          echo "ğŸ“¦ Syncing frontend to S3..."

          # Sync static assets with long cache (JS, CSS, images)
          aws s3 sync ./dist s3://peerprep-frontend-prod \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # Sync HTML files with no cache (for updates)
          aws s3 sync ./dist s3://peerprep-frontend-prod \
            --cache-control "public,max-age=0,must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json"

          echo "âœ… S3 sync complete!"

      - name: Invalidate CloudFront cache
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
          echo "âœ… CloudFront cache invalidated!"
          echo "ğŸŒ Frontend deployed successfully!"

  # Stage 4: Docker Build & Scan
  docker-build-scan:
    name: Docker Build & Scan - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test-backend, build-and-test-frontend]
    if: |
      always() &&
      (needs.detect-changes.outputs.user-service == 'true' ||
       needs.detect-changes.outputs.question-service == 'true' ||
       needs.detect-changes.outputs.collaboration-service == 'true' ||
       needs.detect-changes.outputs.matching-service == 'true')

    strategy:
      matrix:
        include:
          - service: user-service
            changed: ${{ needs.detect-changes.outputs.user-service }}
          - service: question-service
            changed: ${{ needs.detect-changes.outputs.question-service }}
          - service: collaboration-service
            changed: ${{ needs.detect-changes.outputs.collaboration-service }}
          - service: matching-service
            changed: ${{ needs.detect-changes.outputs.matching-service }}
      fail-fast: false

    steps:
      - name: Check if service changed
        id: should-run
        run: |
          if [ "${{ matrix.changed }}" != "true" ]; then
            echo "â­ï¸ Skipping ${{ matrix.service }} - no changes detected"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Running Docker build for ${{ matrix.service }}"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.should-run.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: steps.should-run.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        if: steps.should-run.outputs.skip != 'true'
        working-directory: ./${{ matrix.service }}
        run: |
          echo "ğŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t ${{ matrix.service }}:${{ github.sha }} .

      - name: Scan Docker image with Trivy
        if: steps.should-run.outputs.skip != 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:${{ github.sha }}
          format: "sarif"
          output: "trivy-results-${{ matrix.service }}.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        if: steps.should-run.outputs.skip != 'true'
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: "trivy-results-${{ matrix.service }}.sarif"
          category: ${{ matrix.service }}

      - name: Check for vulnerabilities
        if: steps.should-run.outputs.skip != 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:${{ github.sha }}
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"

  # Stage 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-build-scan]
    if: |
      always() &&
      needs.detect-changes.outputs.collaboration-service == 'true'

    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      mongodb:
        image: mongo:7
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run collaboration service integration tests
        working-directory: ./collaboration-service
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
          npm test
        env:
          MONGO_URI: mongodb://localhost:27017/test
          JWT_SECRET: test-secret
          PORT: 3004
        continue-on-error: true

  # CI Summary
  ci-summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        code-quality,
        build-and-test-backend,
        build-and-test-frontend,
        docker-build-scan,
        integration-tests,
      ]
    if: always()

    steps:
      - name: Check CI status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… CI Pipeline Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Changed Services:"
          echo "  â€¢ user-service: ${{ needs.detect-changes.outputs.user-service }}"
          echo "  â€¢ question-service: ${{ needs.detect-changes.outputs.question-service }}"
          echo "  â€¢ collaboration-service: ${{ needs.detect-changes.outputs.collaboration-service }}"
          echo "  â€¢ matching-service: ${{ needs.detect-changes.outputs.matching-service }}"
          echo "  â€¢ web-server: ${{ needs.detect-changes.outputs.web-server }}"
          echo ""
          echo "Pipeline Status:"
          echo "  â€¢ Code Quality: ${{ needs.code-quality.result }}"
          echo "  â€¢ Backend Build: ${{ needs.build-and-test-backend.result }}"
          echo "  â€¢ Frontend Build: ${{ needs.build-and-test-frontend.result }}"
          echo "  â€¢ Docker Scan: ${{ needs.docker-build-scan.result }}"
          echo "  â€¢ Integration Tests: ${{ needs.integration-tests.result }}"
          echo ""

          # Check if all required jobs succeeded or were skipped
          all_passed=true

          if [ "${{ needs.code-quality.result }}" != "success" ] && [ "${{ needs.code-quality.result }}" != "skipped" ]; then
            all_passed=false
          fi

          if [ "${{ needs.build-and-test-backend.result }}" != "success" ] && [ "${{ needs.build-and-test-backend.result }}" != "skipped" ]; then
            all_passed=false
          fi

          if [ "${{ needs.build-and-test-frontend.result }}" != "success" ] && [ "${{ needs.build-and-test-frontend.result }}" != "skipped" ]; then
            all_passed=false
          fi

          if [ "${{ needs.docker-build-scan.result }}" != "success" ] && [ "${{ needs.docker-build-scan.result }}" != "skipped" ]; then
            all_passed=false
          fi

          if [ "$all_passed" = true ]; then
            echo "âœ… All checks passed - Ready for deployment"
            exit 0
          else
            echo "âš ï¸ Some checks failed - Review before merging"
            exit 0
          fi

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const changes = {
              'user-service': '${{ needs.detect-changes.outputs.user-service }}' === 'true',
              'question-service': '${{ needs.detect-changes.outputs.question-service }}' === 'true',
              'collaboration-service': '${{ needs.detect-changes.outputs.collaboration-service }}' === 'true',
              'matching-service': '${{ needs.detect-changes.outputs.matching-service }}' === 'true',
              'web-server': '${{ needs.detect-changes.outputs.web-server }}' === 'true'
            };

            const changedServices = Object.entries(changes)
              .filter(([_, changed]) => changed)
              .map(([service, _]) => service);

            const changesSection = changedServices.length > 0
              ? `### ğŸ“ Changed Services\n${changedServices.map(s => `- \`${s}\``).join('\n')}\n\n`
              : '### ğŸ“ Changed Services\n_No service changes detected (workflow/config changes only)_\n\n';

            const summary = `## ğŸš€ CI Pipeline Results

            ${changesSection}

            | Stage | Status |
            |-------|--------|
            | Code Quality & Security | ${{ needs.code-quality.result }} |
            | Backend Build & Test | ${{ needs.build-and-test-backend.result }} |
            | Frontend Build | ${{ needs.build-and-test-frontend.result }} |
            | Docker Build & Scan | ${{ needs.docker-build-scan.result }} |
            | Integration Tests | ${{ needs.integration-tests.result }} |

            ${(() => {
              const results = [
                '${{ needs.code-quality.result }}',
                '${{ needs.build-and-test-backend.result }}',
                '${{ needs.build-and-test-frontend.result }}',
                '${{ needs.docker-build-scan.result }}'
              ];
              
              const allPassed = results.every(r => r === 'success' || r === 'skipped');
              
              return allPassed 
                ? 'âœ… **All critical checks passed!** This PR is ready to merge.'
                : 'âš ï¸ **Some checks need attention.** Please review the failures above.';
            })()}

            ---
            ğŸ’¡ _Only changed services were tested to save time and resources._
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
